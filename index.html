<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Shop — Drinks & Foods</title>
  <meta name="description" content="Market shop with user profile (one-time edit) and Telegram checkout integration" />
  <style>
    :root{ --bg:#0b1220; --card:#0f1724; --muted:#9aa4b2; --accent:#ff7a59; --glass: rgba(255,255,255,0.03); --card-2:#0c1626 }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071022 0%, #081428 60%);color:#e6eef8}
    .app{max-width:1150px;margin:28px auto;padding:18px;display:grid;grid-template-columns:1fr 360px;gap:20px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent)}
    header .left{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:18px}
    .search{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;width:360px}
    .panel{background:linear-gradient(180deg,var(--card),var(--card-2));padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;font-weight:600}
    .chip.active{background:linear-gradient(90deg,var(--accent),#7c3aed);color:white}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    .card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;flex-direction:column;gap:8px}
    .thumb{height:140px;border-radius:10px;background-size:cover;background-position:center}
    .title{font-weight:700}
    .meta{font-size:13px;color:var(--muted)}
    .price{font-weight:800}
    .btn{padding:8px 12px;border-radius:10px;border:none;background:var(--accent);color:white;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .cart{position:sticky;top:28px}
    .cart .cart-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .small{font-size:13px;color:var(--muted)}
    .avatar{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#2b6ce6,#7c3aed);font-weight:700}
    /* modal */
    .modal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,0.55)}
    .modal .box{width:100%;max-width:520px;background:#0b1220;padding:18px;border-radius:12px}
    .field{display:flex;gap:8px;margin-top:8px}
    .field input, select{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    footer{grid-column:1/-1;text-align:center;color:var(--muted);margin-top:12px}
    @media (max-width:980px){ .app{grid-template-columns:1fr; padding:12px} .cart{position:relative;top:auto} .search{width:200px} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="left">
        <div class="avatar" id="avatar">U</div>
        <div>
          <h1>Market Shop</h1>
          <div class="small" id="profileText">Loading profile...</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <input id="search" class="search" placeholder="Search products, lunch/snacks/dessert..." />
        <button id="editProfileBtn" class="btn ghost">Edit Profile</button>
      </div>
    </header>

    <main>
      <div class="panel">
        <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
          <div class="chips" id="categories">
            <div class="chip active" data-cat="all">All</div>
            <div class="chip" data-cat="drinks">Drinks</div>
            <div class="chip" data-cat="foods">Foods</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <label class="small">Food type</label>
            <select id="foodType" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">
              <option value="all">All</option>
              <option value="Lunch">Lunch</option>
              <option value="Snacks">Snacks</option>
              <option value="Dessert">Dessert</option>
            </select>
          </div>
        </div>

        <div id="productGrid" class="grid"></div>
      </div>

      <div style="height:14px"></div>
      <div class="panel">
        <h3 style="margin:0">Product details</h3>
        <div id="detail" style="margin-top:12px" class="small">Select a product to view details.</div>
      </div>
    </main>

    <aside class="panel cart">
      <h3 style="margin:0">Cart</h3>
      <div id="cartList" style="margin-top:12px"></div>
      <div id="cartSummary" style="margin-top:12px"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="checkoutBtn" class="btn">Order Now</button>
        <button id="clearCartBtn" class="btn ghost">Clear</button>
      </div>
      <div style="margin-top:10px" class="small">Orders are sent to Telegram bot</div>
    </aside>

    <footer>Demo shop — Single file. Data saved in your browser.</footer>
  </div>

  <!-- Profile modal (one-time edit only) -->
  <div id="profileModal" class="modal" style="display:none">
    <div class="box">
      <h2>Profile (one-time edit)</h2>
      <div class="field"><input id="ln" placeholder="Last name" /><input id="fn" placeholder="First name" /><input id="mn" placeholder="Middle name" /></div>
      <div class="field"><input id="grade" placeholder="Grade (e.g. 12)" /><input id="section" placeholder="Section (e.g. BELL)" /></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="saveProfile" class="btn">Save</button>
        <button id="cancelProfile" class="btn ghost">Cancel</button>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted)">You can edit this profile only <strong>once</strong>. After saving, further edits will be disabled.</div>
    </div>
  </div>

<script>
// --- CONFIG (USER PROVIDED) ---
const TELEGRAM_BOT_TOKEN = '8397045707:AAES7hNLynv3NiAiegUgEVZXoLC0R-Aaoak';
const TELEGRAM_CHAT_ID  = '6064653643';
// -------------------------------

// PRODUCTS
const PRODUCTS = [
  {id:'p1', title:'Waffle Solo', price:30, category:'foods', sub:'Snacks', img:'https://images.unsplash.com/photo-1604908176929-8f7a5b6e1f7e?auto=format&fit=crop&w=800&q=60', desc:'Crispy waffle.'},
  {id:'p2', title:'Iced Coffee', price:60, category:'drinks', img:'https://images.unsplash.com/photo-1511920170033-f8396924c348?auto=format&fit=crop&w=800&q=60', desc:'Cold brewed coffee.'},
  {id:'p3', title:'Chicken Rice', price:120, category:'foods', sub:'Lunch', img:'https://images.unsplash.com/photo-1604908176929-8f7a5b6e1f7e?auto=format&fit=crop&w=800&q=60', desc:'Grilled chicken with rice.'},
  {id:'p4', title:'French Fries', price:80, category:'foods', sub:'Snacks', img:'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=60', desc:'Crispy fries.'},
  {id:'p5', title:'Chocolate Cake', price:110, category:'foods', sub:'Dessert', img:'https://images.unsplash.com/photo-1601992964700-2f8d7d0a6a5c?auto=format&fit=crop&w=800&q=60', desc:'Rich chocolate cake.'}
];

// STORAGE KEYS
const KEY_PROFILE = 'market_profile_v1';
const KEY_PROFILE_EDITS = 'market_profile_edits_v1';
const KEY_CART = 'market_cart_v1';

// APP STATE
let state = {
  profile: load(KEY_PROFILE) || null,
  profileEdits: load(KEY_PROFILE_EDITS) || 0,
  cart: load(KEY_CART) || [],
  category: 'all',
  foodFilter: 'all',
  search: ''
};

// DOM refs
const productGrid = document.getElementById('productGrid');
const cartList = document.getElementById('cartList');
const cartSummary = document.getElementById('cartSummary');
const detail = document.getElementById('detail');
const avatar = document.getElementById('avatar');
const profileText = document.getElementById('profileText');
const profileModal = document.getElementById('profileModal');
const lnI = document.getElementById('ln'), fnI = document.getElementById('fn'), mnI = document.getElementById('mn'), gradeI = document.getElementById('grade'), sectionI = document.getElementById('section');
const editProfileBtn = document.getElementById('editProfileBtn');

// init
render();
attachEvents();

function load(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch(e){ return null; } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

function attachEvents(){
  // category chips
  document.querySelectorAll('.chip').forEach(el=> el.addEventListener('click', ()=>{
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    el.classList.add('active'); state.category = el.dataset.cat; renderProducts();
  }));
  document.getElementById('foodType').addEventListener('change', (e)=>{ state.foodFilter = e.target.value; renderProducts(); });
  document.getElementById('search').addEventListener('input', debounce((e)=>{ state.search = e.target.value; renderProducts(); },200));

  document.getElementById('saveProfile').addEventListener('click', ()=>{
    const ln = lnI.value.trim(), fn = fnI.value.trim(), mn = mnI.value.trim(), gr = gradeI.value.trim(), sec = sectionI.value.trim();
    if(!ln || !fn || !gr || !sec){ alert('Please fill Last, First, Grade, and Section'); return; }
    const formatted = `${ln}, ${fn}${mn? ' ' + mn : ''}`;
    state.profile = { last:ln, first:fn, middle:mn, formatted, grade:gr, section:sec };
    state.profileEdits = (state.profileEdits||0) + 1; // counts as one edit
    save(KEY_PROFILE, state.profile); save(KEY_PROFILE_EDITS, state.profileEdits);
    profileModal.style.display = 'none';
    renderProfile();
  });
  document.getElementById('cancelProfile').addEventListener('click', ()=>{
    if(!state.profile) { alert('Profile required to continue'); return; }
    profileModal.style.display = 'none';
  });

  editProfileBtn.addEventListener('click', ()=>{
    if(!state.profile) { openProfileModal(); return; }
    if((state.profileEdits||0) >= 1){ alert('Profile edit already used.'); return; }
    // allow one-time edit: prefill and show modal
    lnI.value = state.profile.last||''; fnI.value = state.profile.first||''; mnI.value = state.profile.middle||''; gradeI.value = state.profile.grade||''; sectionI.value = state.profile.section||'';
    profileModal.style.display = 'grid';
  });

  document.getElementById('clearCartBtn').addEventListener('click', ()=>{ if(confirm('Clear cart?')){ state.cart=[]; save(KEY_CART,state.cart); renderCart(); } });
  document.getElementById('checkoutBtn').addEventListener('click', onCheckout);
}

function openProfileModal(){
  lnI.value=''; fnI.value=''; mnI.value=''; gradeI.value=''; sectionI.value='';
  profileModal.style.display = 'grid';
}

function render(){
  // if no profile, force modal
  if(!state.profile){ openProfileModal(); } else { renderProfile(); }
  renderProducts(); renderCart();
}

function renderProfile(){
  const p = state.profile;
  if(!p){ profileText.textContent = 'No profile set'; avatar.textContent = 'U'; return; }
  profileText.textContent = `${p.formatted} • Grade ${p.grade} - ${p.section}`;
  avatar.textContent = initials(p.formatted);
}

function initials(name){ return name.split(/[, ]+/).filter(Boolean).map(s=>s[0].toUpperCase()).slice(0,2).join('') || 'U'; }

function renderProducts(){
  productGrid.innerHTML='';
  const q = (state.search||'').toLowerCase().trim();
  const filtered = PRODUCTS.filter(p=>{
    if(state.category !== 'all' && state.category === 'drinks' && p.category !== 'drinks') return false;
    if(state.category === 'foods' && p.category !== 'foods') return false;
    if(state.foodFilter && state.foodFilter !== 'all' && p.sub && p.sub !== state.foodFilter) return false;
    // check q
    const hay = (p.title + ' ' + (p.desc||'') + ' ' + (p.sub||'') + ' ' + p.category).toLowerCase();
    if(q && !hay.includes(q)) return false;
    return true;
  });
  if(filtered.length === 0){ productGrid.innerHTML = '<div class="small">No products</div>'; return; }
  filtered.forEach(p=>{
    const card = document.createElement('div'); card.className='card';
    const t = document.createElement('div'); t.className='thumb'; t.style.backgroundImage = `url(${p.img})`;
    const title = document.createElement('div'); title.className='title'; title.textContent = p.title;
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${p.category}${p.sub ? ' • ' + p.sub : ''}`;
    const bottom = document.createElement('div'); bottom.style.display='flex'; bottom.style.justifyContent='space-between'; bottom.style.alignItems='center';
    const price = document.createElement('div'); price.className='price'; price.textContent = '₱' + Number(p.price).toFixed(2);
    const add = document.createElement('button'); add.className='btn'; add.textContent='Add'; add.onclick = (e)=>{ e.stopPropagation(); addToCart(p.id); };
    bottom.appendChild(price); bottom.appendChild(add);
    card.appendChild(t); card.appendChild(title); card.appendChild(meta); card.appendChild(bottom);
    card.onclick = ()=> showDetail(p.id);
    productGrid.appendChild(card);
  });
}

function showDetail(id){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return; detail.innerHTML = `
    <div style=\"display:flex;gap:12px;align-items:flex-start\">\n      <div style=\"width:180px;height:120px;border-radius:10px;background-image:url('${p.img}');background-size:cover;background-position:center\"></div>\n      <div>\n        <div style=\"font-weight:800;font-size:16px\">${p.title}</div>\n        <div class=\"small\">${p.category}${p.sub? ' • ' + p.sub : ''}</div>\n        <div style=\"margin-top:8px\">${p.desc||''}</div>\n        <div style=\"margin-top:12px;display:flex;gap:8px;align-items:center\">\n          <div style=\"font-weight:800\">₱${Number(p.price).toFixed(2)}</div>\n          <button class=\"btn\" onclick=\"addToCart('${p.id}')\">Add to cart</button>\n        </div>\n      </div>\n    </div>`;
}

function addToCart(id){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
  const found = state.cart.find(c=>c.id===id);
  if(found){ found.qty += 1; } else { state.cart.push({ id:p.id, title:p.title, price:p.price, qty:1, img:p.img }); }
  save(KEY_CART, state.cart); renderCart();
}

function updateQty(i, v){ state.cart[i].qty = Math.max(1, Number(v)||1); save(KEY_CART,state.cart); renderCart(); }
function removeFromCart(i){ state.cart.splice(i,1); save(KEY_CART,state.cart); renderCart(); }

function renderCart(){
  cartList.innerHTML='';
  if(state.cart.length === 0){ cartList.innerHTML = '<div class="small">Cart is empty</div>'; cartSummary.innerHTML=''; return; }
  let total = 0;
  state.cart.forEach((it, idx)=>{
    const row = document.createElement('div'); row.className='cart-item';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${it.title}</div><div class=\"small\">₱${Number(it.price).toFixed(2)} each</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
    const qty = document.createElement('input'); qty.type='number'; qty.value = it.qty; qty.min=1; qty.style.width='64px'; qty.onchange = (e)=> updateQty(idx, e.target.value);
    const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Remove'; del.onclick = ()=> removeFromCart(idx);
    right.appendChild(qty); right.appendChild(del);
    row.appendChild(left); row.appendChild(right);
    cartList.appendChild(row);
    total += it.price * it.qty;
  });
  cartSummary.innerHTML = `<div style="display:flex;justify-content:space-between"><div class=\"small\">Items: ${state.cart.length}</div><div style=\"font-weight:800\">Total: ₱${total.toFixed(2)}</div></div>`;
}

// Checkout -> send to Telegram
async function onCheckout(){
  if(!state.profile){ alert('Please set your profile first'); openProfileModal(); return; }
  if((state.cart||[]).length === 0){ alert('Cart is empty'); return; }

  // build order text
  let total = 0;
  const lines = state.cart.map(it=>{ const line = `- ${it.title} x${it.qty} = ₱${(it.price*it.qty).toFixed(2)}`; total += it.price*it.qty; return line; });
  const header = `My Order:\n\nName: ${state.profile.formatted}\nGrade/Section: ${state.profile.grade} - ${state.profile.section}\n\n`;
  const body = lines.join('\n') + `\n\nTotal: ₱${total.toFixed(2)}`;
  const textMessage = header + body;

  // Show a quick confirmation UI (user sees the summary before sending)
  if(!confirm('Send order to Telegram?\n\n' + body.replace(/\n/g,'\n'))){ return; }

  // attempt to send as message first
  try{
    const sendMsgUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    const resp = await fetch(sendMsgUrl, {
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: textMessage })
    });
    const j = await resp.json();
    if(j && j.ok){
      // try to send photos as media group (photos are remote URLs) — best-effort
      try{
        const media = state.cart.map(it=>({ type:'photo', media: it.img, caption:`${it.title} x${it.qty}` }));
        const mgUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMediaGroup`;
        const mgResp = await fetch(mgUrl, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, media }) });
        const mgJson = await mgResp.json();
        // mgJson may fail due to CORS or Telegram restrictions, but we ignore — it's best-effort
      }catch(e){ console.warn('sendMediaGroup failed (best-effort):', e); }

      alert('Order sent successfully!');
      // clear cart after success
      state.cart = []; save(KEY_CART, state.cart); renderCart();
      return;
    } else {
      throw new Error('Telegram API sendMessage failed');
    }
  }catch(err){
    console.warn('Telegram send failed', err);
    // fallback: copy summary to clipboard and open t.me link for manual send
    try{ await navigator.clipboard.writeText(textMessage); }catch(e){}
    const fallback = confirm('Failed to send order directly due to browser restrictions (CORS/network).\nWe copied the order text to your clipboard.\n\nPress OK to open Telegram web to paste and send manually.');
    if(fallback){
      // open Telegram web chat with bot — cannot prefill message to bot chat, so open bot link instead
      window.open(`https://t.me/${TELEGRAM_CHAT_ID}`, '_blank');
    }
  }
}

// Utilities
function debounce(fn, wait=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

// initial load helpers
renderProfile(); renderProducts(); renderCart();

</script>
</body>
</html>
